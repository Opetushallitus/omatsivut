language: scala
jdk:
  - oraclejdk8
services:
  - docker
  - postgresql

addons:
  postgresql: "9.5"

#cache:
#  directories:
#  - $HOME/.m2

before_script:
  - DB_NAME=valintarekisteri
  - psql -c "create database $DB_NAME;" -U postgres
  # Temporary workaround until valinta-tulos-service works regardless of timezone
  - export TZ=Europe/Helsinki

env:
  global:
    # AWS_ACCESS_KEY_ID
    - secure: "OVK/rR13BwxUYxeOst2FGCjtgE2WXthcRm5+qAId3ozb6e1Mlm0zInYPjCtPbrenecWitKyZ8stoYKm+L+M5Cj2LMd42ASOdUUXNZvtdiKk+PZZITQONW3QCU3HsZoJ+FA+U8qW1pz+BL5PSng98/POw1EIh0fNojfsF7fwpLIg="
    # AWS_SECRET_ACCESS_KEY
    - secure: "REV1rrGLrcplpd6Ug3nEyzKU77YLcxEqWDE7dmhYMfH29Mb5rIms15jpeGoSc54QlaDx1OIt2uHPqwYcrna8e81qBMc1B9jgB2PML+NoLrwL4KTJsW0h8X1RICrOawjAi3HEZXl8ETxxdDkPKnT8lnTp8Yp3FUfFGWrvKKfY/pI="
    # PostgreSQL port
    - PGPORT=5432

install:
  - git clone https://github.com/Opetushallitus/ci-tools.git
  - source ci-tools/common/setup-tools.sh
  - sudo sh -c "printf '\n%s penaali.hard.ware.fi\n' $(dig +short artifactory.opintopolku.fi|head -n1) >> /etc/hosts"
  - nvm use node 6

script:
  - export ARTIFACT_NAME=omatsivut
  - ./cibuild.bash
  - export BASE_IMAGE="base-legacy:0.1"
  - ./ci-tools/common/pull-image.sh
  - ./ci-tools/build/build-war.sh $ARTIFACT_NAME

deploy:
  - provider: script
    script:
      ./ci-tools/build/upload-image.sh $ARTIFACT_NAME
    on:
      all_branches: true
