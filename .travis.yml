sudo: required
language: scala
scala:
  - 2.11.8
jdk:
  - openjdk8
services:
  - docker
  - postgresql

addons:
  postgresql: "9.5"

cache:
  directories:
  - $HOME/.m2
  - $HOME/.embedmongo

before_script:
  - DB_NAME=valintarekisteri
  - OMATSIVUT_DB_NAME=omatsivutdb
  - psql -c "create database $DB_NAME;" -U postgres
  - psql -c "create database $OMATSIVUT_DB_NAME;" -U postgres
  - psql -d $OMATSIVUT_DB_NAME -f postgresql/init_omatsivut_it_postgresql.sql
  # Temporary workaround until valinta-tulos-service works regardless of timezone
  - export TZ=Europe/Helsinki

env:
  global:
    # AWS_ACCESS_KEY_ID
    - secure: "MrD84Bf2Zyn3ijlL3/w1thWdWyVUVrgKDe/fQdq/VKGc/0UMJZs94cxl8Am3F8UQFQGKR1oFC1R53WvfLflcFznNwlj6YzV9Hjlkd/hF336IPU6TT9LgjDqGFa3DbSgHJScx+rqKqJ/ZlFLjHul0Fo+eKVe7Q5biCFBl53k7XZ8="
    # AWS_SECRET_ACCESS_KEY
    - secure: "edFMjZ/OUOUhfRgLs9QBKrqtM+4ZuEZxaQdcL9VqKgrEaeZo0ORBlS+e5aujTJUNMa00+P+yo/1hp0zHSGzqVz/NTbpsujKUjDZDZ0d9QULMFvbleJo0nN9Ghm6zwKjMTgiUPt4epd5poB8XHbh/tcUf0USjDoI7isxC1S07nQM="
    # PostgreSQL port
    - PGPORT=5432

install:
  - git clone https://github.com/Opetushallitus/ci-tools.git
  - source ci-tools/common/setup-tools.sh
  - sudo sh -c "printf '\n%s penaali.hard.ware.fi\n' $(dig +short artifactory.opintopolku.fi|head -n1) >> /etc/hosts"
  - nvm install 8

script:
  - export ARTIFACT_NAME=omatsivut
  # This is needed for the maven-dependency-plugin to work to get valinta-tulos-service.war
  - sudo chown -R travis:travis $HOME/.m2
  - nvm use 8 && ./cibuild.bash
  - export BASE_IMAGE="baseimage-fatjar-openjdk8:ci-125"
  - ./ci-tools/common/pull-image.sh
  - ./ci-tools/build/build-fatjar.sh $ARTIFACT_NAME

deploy:
  - provider: script
    script:
      ./ci-tools/build/upload-image.sh $ARTIFACT_NAME
    on:
      all_branches: true
